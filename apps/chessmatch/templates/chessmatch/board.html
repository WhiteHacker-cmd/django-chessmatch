{%extends "base.html"%}

{%block scripts%}
{{super()}}
<script>
    window.latest_seen = '';

    window.unicodes = {
        'K': '&#9818',
        'Q': '&#9819',
        'R': '&#9820',
        'B': '&#9821',
        'N': '&#9822',
        'P': '&#9823',
    }
    window.colors = ['white','red','black','green'];

    window.game_actions = []

    function fetch_history() {
        $.get('{{url('chessmatch_history', slug=game.slug)}}'+latest_seen, function(data) {
            for (var i=0; i < data.length; i++) {
                move = data[i]

                // create and/or position piece
                var $square = $('#square-'+move.to_coord)
                var color = window.colors[move.color]
                if (move.from_coord) {
                    var $piece = $('#square-'+move.from_coord+' .piece')
                }
                else { // first placement, create it
                    var $piece = $('<div class="piece '+color+'" id="piece_'+move.piece+'-'+color+'"/>')
                    $piece.html(window.unicodes[move.piece])
                }
                $piece.attr('square', move.to_coord)
                $square.empty()
                $square.append($piece)


                // game log
                window.game_actions.push(move)
                if (move.turn > 0) {
                    var $tr = $('tr#turn-'+move.turn);
                    if ($tr.length < 1) {
                        $tr = $('<tr id="turn-'+move.turn+'" actions_idx="'+(window.game_actions.length-1)+'"><th>'+move.turn+'.</th></tr>')
                        $('#movelist').append($tr)
                    }
                    var $td = $tr.find('td.color-'+color)
                    if ($td.length < 1) { // add move to the log
                        $td = $('<td class="color-'+color+'">'+move.expr+'</td>')
                        $tr.append($td)
                    }
                }

                window.latest_seen = move.turn+'.'+move.color;
            }

            setTimeout(fetch_history, 10000)
        })
    }

    $(function() {
        fetch_history();
    })
</script>
{%endblock%}

{%block content%}

    <section class="game-info">
        <h1>{{game.name}}</h1>
        {# <h3>{{game.comma_players}}</h3> #}

        {%if not game.started_at%}
        <a href="{{url('chessmatch_start', slug=game.slug)}}">Start Game</a>
        {%endif%}
    </section>


    <section class="game-board">
        <table class="chessboard">
            <tr>
                <th></th><th>a</th><th>b</th><th>c</th><th>d</th><th>e</th><th>f</th><th>g</th><th>h</th><th>i</th><th>j</th><th>k</th><th>l</th><th>m</th><th>n</th>
            </tr>
        {%for rank in range(14,0,-1)%}
            <tr>
                <th>{{rank}}</th>
                {%for file in 'abcdefghijklmn'%}
                    <td class="square 
                        {%if rank % 2%} 
                            {%if file in 'acegikm'%}black{%else%}white{%endif%} 
                        {%else%} 
                            {%if file in 'bdfhjln'%}black{%else%}white{%endif%} 
                        {%endif%} 

                        {%if (rank < 4 and file in 'abclmn') or (rank > 11 and file in 'abclmn') %}
                            unusable
                        {%endif%}
                        " 
                        id="square-{{file}}{{rank}}">
                    </td>
                {%endfor%}
                <th>{{rank}}</th>
            </tr>
        {%endfor%}
            <tr>
                <th></th><th>a</th><th>b</th><th>c</th><th>d</th><th>e</th><th>f</th><th>g</th><th>h</th><th>i</th><th>j</th><th>k</th><th>l</th><th>m</th><th>n</th>
            </tr>
        </table>
    </section>

    <section class="game-log">
        <table id="movelist">
            <tr class="names">
                <th></th>
                <th>White {{macros.render_avatar(players[0])}}</th>
                <th>Red {{macros.render_avatar(players[1])}}</th>
                <th>Black {{macros.render_avatar(players[2])}}</th>
                <th>Green {{macros.render_avatar(players[3])}}</th>
            </tr>
        </table>
    </section>

{%endblock%}
